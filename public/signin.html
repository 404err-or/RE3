<!DOCTYPE html>
<html lang="ko">
<head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <title>2022RE</title>
	<link href="bootstrap.css" rel="stylesheet">
    <script src="jQuery.js"></script>
    <style>
		.bd-placeholder-img {
			font-size: 1.125rem;
			text-anchor: middle;
			-webkit-user-select: none;
			-moz-user-select: none;
			user-select: none;
		}
		@media (min-width: 768px) {
			.bd-placeholder-img-lg {
			font-size: 3.5rem;
			}
		}
		input.form-control {
			width: 100%;
			background-color: transparent;
			border: none;
			border-bottom: 1px solid #999;
			font-size: 18px;
			color: #000;
			outline: none;
		}
        .container {
            max-width: 960px;
        }
        #invalid_same_name, #valid_same_name, div.email_verify, #same_email, button#verify_email, #verify_pw {
            display: none;
        }
    </style>
    <script src="https://ssl.daumcdn.net/dmaps/map_js_init/postcode.v2.js"></script>
	<script>
        $(document).ready(function(){
            $input_name = $('input#name');
            $('input#name').val( $('input#name').val().replace(/[^a-z0-9\-]/g, '') );
            $input_name.on('keyup',function(){
                let name = $('input#name');
                let nickname = name.val().replace(/[^a-z0-9\-]/g, '');
                name.val( nickname );
            });
            $(document).on('keyup', 'input#valid_pw', function(){
                
            })
            // $(document).on('submit', 'form.needs-validation', function(event) {
            //     event.preventDefault();
            //     event.stopPropagation();
            //     form = $('form.needs-validation');
            //     form.addClass('was-validated');
            //     if (form.checkValidity() && !func_verify_email() && func_same_name()) {
            //         $('form.needs-validation').submit();
            //     }
            // })
        })
        const func_same_name = () => { // 닉네임 중복확인
            let name = $('input#name').val();
            if(name) {
                $.ajax({
                    type: 'post',
                    url: '/same_name',
                    data: { name },
                    success: (data) => {
                        if(data == 'success') {
                            $('#valid_same_name').css('display', 'block');
                            $('#invalid_same_name').css('display', 'none');
                            return true;
                        } else if(data == 'fail') {
                            $('#valid_same_name').css('display', 'none');
                            $('#invalid_same_name').css('display', 'block');
                            return false;
                        } else {
                            alert('오류가 발생');
                            return false;
                        }
                    },
                    error: (err) => {
                        console.log(err)
                        return false;
                    }
                });
            } else {
                return false;
            }
        };
        const func_same_email = () => { // 이메일 중복확인
            let email_element = $('input#email');
            let email = email_element.val();
            if(email && email_element[0].checkValidity()) {
                $.ajax({
                    type: 'post',
                    url: '/same_email',
                    data: { email },
                    success: (data) => {
                        if(data == 'success') {
                            $('#empty_email').css('display', 'none');
                            $('#same_email').css('display', 'none');
                            return true;
                        } else if(data == 'fail') {
                            $('#empty_email').css('display', 'none');
                            $('#same_email').css('display', 'block');
                            return false;
                        } else {
                            alert('오류가 발생');
                            return false;
                        }
                    },
                    error: (err) => {
                        console.log(err)
                        return false;
                    }
                });
            }  else {
                $('#empty_email').css('display', 'block');
                return false;
            }
        };
        const func_check_email = () => { // 인증메일 보내기
            $('button#check_email').attr('disabled', true);
            $('input#email').attr('disabled', true);
            let email_element = $('input#email');
            let email = email_element.val();
            if(email && email_element[0].checkValidity()) {
                $.ajax({
                    type: 'post',
                    url: '/check_email',
                    data: { email },
                    success: (data) => {
                        console.log(data);
                        if(data == 'success') {
                            $('div.email_verify').css('display','block');
                            $('button#verify_email').css('display','block');
                            alert('이메일을 발송하였습니다. 10분 이내에 인증을 완료해주세요.');
                            return true;
                        } else if(data == 'fail') {
                            $('div.email_verify').css('display','none');
                            $('button#verify_email').css('display','none');
                            return false;
                        } else {
                            alert('오류가 발생');
                            return false;
                        }
                    },
                    error: (err) => {
                        console.log(err)
                        return false;
                    }
                });
            } else {
                return false;
            }
        };
        const func_verify_email = () => { // 메일인증 확인하기
            let code = $('input#email_verify').val();
            let email_element = $('input#email');
            let email = email_element.val();
            if(email && email_element[0].checkValidity() && code) {
                $.ajax({
                    type: 'post',
                    url: '/verify_email',
                    data: { email, code },
                    success: (data) => {
                        console.log(data);
                        if(data == 'success') {
                            $('#valid_email_verify').css('display','block');
                            $('#invalid_email_verify').css('display','none');
                            $('input#email_verify').attr('disabled',true);
                            $('button#verify_email').attr('disabled',true);
                            return true;
                        } else if(data == 'fail') {
                            $('#valid_email_verify').css('display','none');
                            $('#invalid_email_verify').css('display','block');
                            return false;
                        } else {
                            alert('오류가 발생');
                            return false;
                        }
                    },
                    error: (err) => {
                        console.log(err)
                        return false;
                    }
                });
            } else {
                return false;
            }
        };
        const valid_pw = () => {
            let pw = $('input#pw').val();
            let valid_pw = $('input#valid_pw').val();
            if(pw && pw == valid_pw && pw.length >= 8) return true;
            else return false;
        };
        function debounce(callback, wait) {
            let timeout;
            return (...args) => {
                clearTimeout(timeout);
                timeout = setTimeout(function () { callback.apply(this, args); }, wait);
            };
        }
        window.onload = () => {
            document.getElementById('name').addEventListener('keyup', debounce( () => {
                func_same_name();
            }, 1000));
            document.getElementById('email').addEventListener('keyup', debounce( () => {
                func_same_email();
            }, 1000));
        }
        
        </script>
</head>
<body class="bg-light">
	<div class="container">
		<main>
			<div class="py-5 text-center">
				<h2>2022 R&amp;E</h2>
				<p class="lead" style="text-align:center;word-break: keep-all;">이 페이지는 2022년 졸업논문 R&E 중 채팅을 위한 회원가입 페이지입니다.</p>
			</div>
			<div class="row g-5" style="align-items: center;justify-content: center;">
				<div class="col-md-7 col-lg-8">
					<h4 class="mb-3">회원가입</h4>
					<form class="needs-validation" novalidate="" method="post" action="/signin">
						<div class="row g-3">
							<div class="col-12">
								<label for="name" class="form-label">닉네임</label>
								<div class="row">
                                    <div class="col-9">
                                        <input type="text" name="name" pattern="^[a-z0-9\-]+$" class="form-control" id="name" placeholder="ex. 404err-or" maxlength="15" required="">
                                        <div class="invalid-feedback" id="empty_name">
                                            닉네임 칸이 비었습니다.
                                        </div>
                                        <div class="invalid-feedback" id="invalid_same_name">
                                            중복된 닉네임입니다.
                                        </div>
                                        <div class="valid-feedback" id="valid_same_name">
                                            사용가능한 닉네임입니다.
                                        </div>
                                    </div>
                                    <div class="col-3">
                                        <button type="button" class="btn btn-primary" onclick="func_same_name()">중복 확인</button>
                                    </div>
                                </div>
                                
                                <div class="link-danger">한 번 정한 닉네임은 변경이 불가능합니다.</div>
                                <div class="link-danger">닉네임은 '-', 영어 소문자, 숫자만 가능하며,<br>그 외 문자를 포함할 수 없습니다.</div>
							</div>
							<div class="col-12">
                                <label for="email" class="form-label">이메일</label>
                                <div class="row">
                                    <div class="col-9">
                                        <input type="email" pattern=".+@gsa\.hs\.kr" id="email" name="email" class="form-control" placeholder="ex. students@gsa.hs.kr" value="@gsa.hs.kr" required="">
                                        <div class="invalid-feedback" id="empty_email">
                                            이메일 칸이 비었습니다.
                                        </div>
                                        <div class="invalid-feedback" id="same_email">
                                            이메일이 중복되었습니다.
                                        </div>
                                        <div class="email_verify">
                                            <input type="text" id="email_verify" name="email_verify" class="form-control" placeholder="이메일로 받은 암호" required="">
                                            <div class="valid-feedback" id="valid_email_verify">
                                                인증에 성공하였습니다.
                                            </div>
                                            <div class="invalid-feedback" id="invalid_email_verify">
                                                인증에 실패하였습니다.
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-3">
                                        <button type="button" class="btn btn-primary" id="check_email" onclick="func_check_email()">인증 발송</button>
                                        <button type="button" class="btn btn-primary" id="verify_email" onclick="func_verify_email()">인증</button>
                                    </div>
                                </div>
                                <div class="link-danger">학교 계정(gsa.hs.kr만 등록할 수 있습니다.)</div>
							</div>
                            <div class="col-12">
                                <label for="email" class="form-label">비밀번호</label>
                                <input type="password" id="pw" name="pw" class="form-control" minlength="8" required="">
                                <div class="invalid-feedback" id="empty_pw">
                                    비밀번호 칸이 비었습니다.
                                </div>
                                <div class="invalid-feedback" id="notallowed_pw">
                                    비밀번호는 8자리 이상이어야합니다.
                                </div>
                                <input type="password" id="valid_pw" name="valid_pw" class="form-control" minlength="8" required="">
                                <div class="invalid-feedback" id="notallowed_valid_pw">
                                    비밀번호 확인 칸이 비었습니다.
                                </div>
                            </div>
                            <div class="invalid-feedback" id="verify_pw">
                                비밀번호가 알맞지 않습니다.
                            </div>
						</div>
						<hr class="my-4">
						<h4 class="mb-3">개인정보 동의서</h4>
						<p class="lead" style="text-align:center;word-break: keep-all;">이용자가 제공한 모든 정보는 연구활동을 위해 활용되며, 목적 이외의 용도로는 사용되지 않습니다. 개인정보 수집, 이용, 제공하는 것에 동의합니다.</p>
						<div class="my-3">
							<div class="form-check">
								<input id="yes" name="agree" type="radio" class="form-check-input" value="yes" required="">
								<label class="form-check-label" for="yes">예</label>
                                <div class="invalid-feedback">
                                    개인정보 동의서에 동의하지 않았습니다. 동의하지 않으면 해당 사이트를 이용하실 수 없습니다.
                                </div>
							</div>
						</div>
						<hr class="my-4">
						<button class="w-100 btn btn-primary btn-lg" type="submit">회원가입!</button>
					</form>
				</div>
			</div>
		</main>
		<footer class="my-5 pt-5 text-muted text-center text-small">
			<p class="mb-1">© 2022. 404err-or all rights reserved.</p>
		</footer>
	</div>
	<script src="bootstrap.js"></script>
	<script>
        // Example starter JavaScript for disabling form submissions if there are invalid fields
        (function () {
        'use strict'

        // Fetch all the forms we want to apply custom Bootstrap validation styles to
        var forms = document.querySelectorAll('.needs-validation')

        // Loop over them and prevent submission
        Array.prototype.slice.call(forms)
            .forEach(function (form) {
            form.addEventListener('submit', function (event) {
                if (!form.checkValidity() || !func_verify_email() || !func_same_name()) {
                    event.preventDefault()
                    event.stopPropagation()
                }
                form.classList.add('was-validated')
            }, false)
            })
        })()
    </script>
</body>
</html>